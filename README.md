# Gradle Example
> gradle-version: 7.0.2  
> java-version: 16

[![Quality gate](https://sonarcloud.io/api/project_badges/quality_gate?project=com.example.myproduct.services%3Aapp)](https://sonarcloud.io/dashboard?id=com.example.myproduct.services%3Aapp)

[![Build](https://github.com/srcmaxim/gradle-example/actions/workflows/build.yml/badge.svg)](https://github.com/srcmaxim/gradle-example/actions/workflows/build.yml)
[![Docker Repository](https://img.shields.io/badge/docker-latest-brightgreen)](https://quay.io/repository/srcmaxim/gradle-example-app?tab=tags)
[![Artifact Hub](https://img.shields.io/endpoint?url=https://artifacthub.io/badge/repository/gradle-example)](https://artifacthub.io/packages/search?repo=gradle-example)

- com.example.myproduct.domain:avro-events  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:avro-events&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:avro-events)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:avro-events&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:avro-events)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:avro-events&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:avro-events)
- com.example.myproduct.domain:events  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:events&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:events)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:events&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:events)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:events&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:events)
- com.example.myproduct.domain:entities  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:entities&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:entities)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:entities&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:entities)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.domain:entities&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.domain:entities)
- com.example.myproduct.features:cat  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:cat&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:cat)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:cat&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:cat)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:cat&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:cat)
- com.example.myproduct.features:cat-api  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:cat-api&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:cat-api)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:cat-api&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:cat-api)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:cat-api&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:cat-api)
- com.example.myproduct.features:entity  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:entity&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:entity)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:entity&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:entity)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:entity&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:entity)
- com.example.myproduct.features:entity-api  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:entity-api&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:entity-api)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:entity-api&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:entity-api)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.features:entity-api&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.features:entity-api)
- com.example.myproduct.services:app  
  [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.services:app&metric=alert_status)](https://sonarcloud.io/dashboard?id=com.example.myproduct.services:app)
  [![Bugs](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.services:app&metric=bugs)](https://sonarcloud.io/dashboard?id=com.example.myproduct.services:app)
  [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=com.example.myproduct.services:app&metric=code_smells)](https://sonarcloud.io/dashboard?id=com.example.myproduct.services:app)
  

> You can open this sample inside an IDE using the [IntelliJ's Gradle import](https://www.jetbrains.com/help/idea/gradle.html#gradle_import_project_start) or [Eclipse Buildship](https://projects.eclipse.org/projects/tools.buildship).  
> You can add [Google CheckStyle config](build-logic/commons/src/main/resources/StyleSources.md) for your IDE.

This sample shows how to structure a software product that consists of multiple components as a set of connected Gradle builds.
As such, it shows how Gradle is used to model a project's architecture and reflect that in the physical structure of the files that make up the software.
This example is described as part of the [documentation on this topic](https://docs.gradle.org/7.0/userguide/structuring_software_products.html).

The product that is built in this sample is an application that displays link: [Gradle Build Tool releases](https://gradle.org/releases/).

There are different ways to work with the sample:

- You may build or import the umbrella build in the root.
  There you can, for example, run the Spring Boot web application via `./gradlew :services:app:bootRun` or build events domain using `./gradlew :domain:events:build`.
- You may only build or import one of the application builds directly.
  For example, `cd services` and run the app using  `../gradlew :app:bootRun`.
- You may only build or import a selected component (and its dependencies).
  For example, only import the `features/cat` in the IDE.

## Setup [SonarCloud](https://sonarcloud.io/)

1. Create an Organization
   - Organization must match GitHub username
   - Add SONAR_TOKEN to GitHub security 
2. Setup a Quality Profile:
   - Go to Administration > New Code > Number of days
   - Set 30 days
3. Create Projects:
   - Go to Administration > Projects Management
   - Create Project\[name=app,key=com.example.myproduct.services:app]
    
## Setup [Quay.io](https://quay.io) Docker registry

1. Create repository for app: gradle-example-app
2. Create User Robot Account with repository write access
3. Add Robot Account DOCKER_USER, DOCKER_TOKEN to GitHub Security

## Create Docker

```bash
gradlew :services:app:build
docker build -f services/app/src/docker/Dockerfile -t gradle-example-app services/app
```

## Build in Docker

```bash
docker build -f services/app/src/docker/Dockerfile.build -t gradle-example-app .
docker run -p80:8080 -t -i gradle-example-app # Use CTRL+C to close
curl -w "\n" http://localhost/cat
curl -w "\n" http://localhost/entity
hey -c 12 -n 200 -z 30s http://localhost/cat # Optional load testing
```

## Build in [Quay.io](https://quay.io) Docker registry

For Java 16 build specify:

1. Dockerfile location: /services/app/src/docker/Dockerfile.build
2. Context location: /
3. Branches/tags: ALL
4. Pull robot: (use your robot account here)
5. Tagging options:
   - branch/tag name
   - latest if default branch
   - java-16-${parsed_ref.branch}-${commit_info.short_sha}
   - java-16-${parsed_ref.branch}
   - java-16-${commit_info.short_sha}
    
## Setup CI notifications with [Telegram Bot](https://telegram.org/blog/bot-revolution) and [CloudFlare Workers](https://workers.cloudflare.com/)

Telegram Bot for CI notifications.

1. Telegram Bot
   - Create Telegram Bot from @BotFather bot
   - Generate TELEGRAM_BOT_TOKEN for your bot
   - Get your TELEGRAM_USER_ID from @UserIdInfoBot
2. CloudFlare Workers
   - Create Worker with code provided in [index.js](/tools/telegram-bot-tool/index.js)
   - Add secrets: TELEGRAM_USER_ID, TELEGRAM_BOT_TOKEN

For additional information refer to telegram-bot [README.md](/tools/telegram-bot-tool/README.md)

## Build and Run Project in Docker Compose

```bash
docker-compose -f envs/local-env/docker-compose.yml up --build
```

## Run Project in microk8s

1. Install [microk8s](https://microk8s.io/)
2. Deploy app

```bash
microk8s status --wait-ready 1️⃣
microk8s config > ~/.kube/config
kubectl get all --all-namespaces

microk8s enable dashboard 2️⃣
microk8s dashboard-proxy

kubectl create namespace dev 3️⃣
kubectl apply -f envs/kubernetes-env -n dev

kubectl get deployments app 4️⃣
kubectl describe deployments app
kubectl get services app
kubectl describe services app

kubectl get replicasets 5️⃣
kubectl describe replicasets <app-XXXXXXXX>
kubectl describe pod <app-XXXXXXXX-XXXXX>
kubectl logs <app-XXXXXXXX-XXXXX>
```

1️⃣ Setup microk8s and configure kubectl  
2️⃣ Enable dashboard proxy  
3️⃣ Create all services in dev. To create a specific service use: 
```bash
kubectl apply -f services/app/src/kubernetes -n dev
```
4️⃣ Describe deployment and service  
5️⃣ Describe pod

3. Get app response:

```bash
export NODE_PORT=$(kubectl get --namespace dev -o jsonpath="{.spec.ports[0].nodePort}" services app)
export NODE_IP=$(kubectl get nodes --namespace dev -o jsonpath="{.items[0].status.addresses[0].address}")
echo http://$NODE_IP:$NODE_PORT/cat
echo http://$NODE_IP:$NODE_PORT/entity
 ```

4. Get app response inside kubernetes:

```bash
kubectl run curl-app --image=radial/busyboxplus:curl -i --tty --rm -n dev
```

## Run project with HELM

1. Install [HELM](https://helm.sh/docs/intro/install/)
2. Deploy app

```bash
git checkout --orphan gh-pages 1️⃣
cat << EOF > index.html
<html>
<head>
  <title>gradle-example charts repository</title>
</head>
<body>
  <h1>gradle-example charts repository</h1>
  <p>Add this repository</p>
  <pre>helm repo add gradle-example https://srcmaxim.github.io/gradle-example</pre>
</body>
</html>
EOF
cat << EOF > README.md
# gradle-example charts repository
Add this repository
`helm repo add gradle-example https://srcmaxim.github.io/gradle-example`
EOF
helm package envs/helm-env/gradle-example
helm repo index . --url https://srcmaxim.github.io/gradle-example/
git add gradle-example-*.tgz index.yaml index.html README.md
git commit -m "Add HELM artifact gradle-example:1.0.0"

helm repo add gradle-example https://srcmaxim.github.io/gradle-example/ 2️⃣
repo list
helm repo update

kubectl create namespace dev 3️⃣
helm install gradle-example gradle-example/gradle-example -n dev
```

1️⃣ Create HELM artifact `gradle-example` in [GitHub pages](https://pages.github.com/) from `gh-pages` branch  
2️⃣ Add HELM repository  
3️⃣ Apply HELM to kubernetes

3. Add HELM repository to [ArtifactHUB](https://artifacthub.io/)

4. Get app response:

```bash
export NODE_PORT=$(kubectl get --namespace dev -o jsonpath="{.spec.ports[0].nodePort}" services gradle-example)
export NODE_IP=$(kubectl get nodes --namespace dev -o jsonpath="{.items[0].status.addresses[0].address}")
curl -w "\n" http://$NODE_IP:$NODE_PORT/cat
curl -w "\n" http://$NODE_IP:$NODE_PORT/entity
 ```

## Deploy project with [Argo CD](https://argoproj.github.io/argo-cd/) and plain YAML

1. Deploy application

```bash
kubectl create namespace argocd 1️⃣ 
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl port-forward svc/argocd-server -n argocd 8080:443

VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" \ 2️⃣ 
  | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/$VERSION/argocd-linux-amd64
chmod +x /usr/local/bin/argocd

kubectl describe secrets/argocd-initial-admin-secret -n argocd 3️⃣ 
password = $(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 -d)
argocd login localhost:8080 --username admin --password $password --insecure
argocd account update-password

argocd app create gradle-example --repo https://github.com/srcmaxim/gradle-example.git \ 4️⃣ 
  --path envs/kubernetes-env --dest-server https://kubernetes.default.svc --dest-namespace dev
argocd app get gradle-example 5️⃣ 
argocd app sync gradle-example 6️⃣
```

1️⃣ Install [Argo CD](https://argoproj.github.io/argo-cd/)  
2️⃣ Download [Argo CD CLI](https://argoproj.github.io/argo-cd/cli_installation/)  
3️⃣ Access The Argo CD API Server  
4️⃣ Create An Application From A Git Repository  
5️⃣ See app info  
6️⃣ Sync (Deploy) app

2. Get app response:

```bash
export NODE_PORT=$(kubectl get --namespace dev -o jsonpath="{.spec.ports[0].nodePort}" services app)
export NODE_IP=$(kubectl get nodes --namespace dev -o jsonpath="{.items[0].status.addresses[0].address}")
curl -w "\n" http://$NODE_IP:$NODE_PORT/cat
curl -w "\n" http://$NODE_IP:$NODE_PORT/entity
 ```

## Recommended Project Structure

```yml
- aggragegation
  - test-aggregate
  - build-aggregate
- build-logic
  - avro-liblary
  - commons(jacoco, checkstyle, sonarqube)
  - java-liblary
  - report-aggreagation
  - spring-boot-app
  - lambda-app
- domain
  - entity
  - dto
  - avro-event(generated)
  - event
  - mapper(depends on entity, dto, event)
- platforms
  - plugin-platform
  - product-platform
  - test-platform
- features
  - [name]-feature-api(optional)
  - [name]-feature
- services
  - [name]-service
- lambdas
  - [name]-lambda
- commons(common modules)
  - [name]-common
- tools
  - [name]-tool
- envs
  - local-env
  - aws-env
```

## Commands

|Command||
|:---|---|
|Run app|`./gradlew :services:app:run`
|Build app| `./gradlew :services:app:build`
|Test app|`./gradlew :features:cat:test --continuous`
|Run linter report|`./gradlew :aggregation:test-aggregate:linterReport`
|Run coverage report|`./gradlew :aggregation:test-aggregate:codeCoverageReport`
|Run sonar report|`./gradlew sonar`
|Run all reports|`./gradlew :aggregation:test-aggregate:check sonar`
|Clean all|`./gradlew clean`
